<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-3.6.0.js"></script>
    <script type='text/javascript' src='http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js'></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <style>
        #next:hover,
        #pre:hover,
        #first:hover,
        #last:hover {
            color: brown;
            cursor: pointer;
        }

    </style>
</head>
<body>

<div align="center">
    <h1>

        <span id="title"></span>
    </h1>

    发布时间
    <span id="releaseTime"></span>
    &nbsp&nbsp&nbsp&nbsp&nbsp作者
    <span id="author"></span>
    <span id="autohId" hidden></span>
    <br><br>
    <span id="content"></span><br>
    <br>
    <img src="" id="img">
    <div id="qrcode" align="center"></div>


    <table id="tab">
    </table>

    <div style="margin-bottom: 30px">
        点赞数：<span id="likeNum"></span>&nbsp&nbsp&nbsp
        <input type="button" value="点赞" id="like"> &nbsp&nbsp&nbsp
        <input type="button" id="concern" value="关注">&nbsp&nbsp&nbsp
        <span id="collect">收藏</span>&nbsp&nbsp&nbsp
        <span id="share">分享</span>&nbsp&nbsp&nbsp
        <span id="report">举报</span>
    </div>
    评论<input type="text" id="comment">
    <input type="button" id="btn" value="发表">
    <br><br>
    <div id="commentList"></div>

    <div id="show" hidden="hidden">
        <textarea name="description" style="resize:none" cols="20" rows="20" placeholder="请输入内容"
                  id="reportcontent"></textarea>
        <input type="file" id="reportimg" value="图片">
        <select id="type">
            <option value="样式问题">
                样式问题
            </option>
            <option value="侮辱谩骂">
                侮辱谩骂
            </option>
            <option value="涉嫌广告">
                涉嫌广告
            </option>
            <option value=" 内容抄袭">
                内容抄袭
            </option>
            <option value=" 政治相关 ">
                政治相关
            </option>
            <option value="内容涉黄">
                内容涉黄
            </option>
            <option value="内容侵权">
                内容侵权
            </option>
            <option value="其他">
                其他
            </option>
        </select>
        <input type="button" value="提交" id="submit">
        <input type="button" value="取消" id="cancelReport">
    </div>
    <div id="replyShow" hidden="hidden">
        <input id="reply" type="text">
        <span id="push">发表</span>
        <span id="cancel">取消</span>
    </div>
</div>

</body>
<script>
    var show = 0
    $('#qrcode').qrcode({width: 100, height: 100, correctLevel: 0, render: "table", text: location.href});
    $("#qrcode").hide()
    //生成当前网页的二维码
    $("#share").click(function () {
        if (show == 0) {
            $("#qrcode").show()
            show = 1;
        } else if (show == 1) {
            $("#qrcode").hide()
            show = 0
        }

    })


    //获取当前博客的id
    var blogId = location.href.substring(location.href.lastIndexOf('=') + 1)
    var user
    /**
     *获取当前博客的内容
     */
    $.ajax({
        url: "blog/getBlog",
        type: "POST",
        data: {BlogId: blogId},
        success: function (res) {
            user=res.user
            $('#autohId').val(res.author.userId)
            $('#title').html(res.Blog.title)
            $("#content").html(res.Blog.content)
            $("#likeNum").html(res.Blog.likeNum)
            $("#img").attr("src", res.Blog.imgPath)
            $("#releaseTime").html(time(res.Blog.releaseTime))
            $("#author").html(res.author.nickName)
            parent(res.commentList)

        }

        ,
        dataType: "json"
    });

    /**
     * 点赞功能
     */
    $("#like").click(function () {
        $.ajax({
            url: "blog/like",
            type: "POST",
            data: {BlogId: blogId},
            success: function (res) {
                if (res == 0) {
                    alert("请先登录")
                } else {
                    $("#likeNum").html(res.likeNum)
                }
            },
            dataType: "json",
        });
    })

    /**
     * 发表评论功能
     */
    $("#btn").click(function () {
        $.ajax({
            url: "comment/comment",
            type: "POST",
            data: {blogId: blogId, comment: $("#comment").val()},
            success: function (res) {
                if (res == 0) {
                    alert("请先登录")
                    return;
                }
                if (res == 2) {
                    alert("你已被封禁,无法进行评论操作")
                    return
                }
                if ($("#comment").val() == "") {
                    alert("评论不能为空")
                    return;
                } else {
                    alert("发表成功")
                    location.reload()
                }
            },
            dataType: "json",
        });
    })

    /**
     * 添加关注功能
     */
    $("#concern").click(function () {
        $.ajax({
            url: "blog/addConcern",
            type: "POST",
            data: {authorId: $("#autohId").val()},
            success: function (res) {
                if (res == 1) {
                    alert("添加成功")
                } else if (res == 2) {
                    alert("不能关注自己")
                } else if (res == 0) {
                    alert("请先登录")
                } else {
                    alert("取关成功")
                }
            },
            dataType: "json",
        });
    })

    /**
     * 收藏功能
     */
    $("#collect").click(function () {
        $.ajax({
            url: "collect/addCollect",
            type: "POST",
            data: {blogId: blogId},
            success: function (res) {
                if (res == 1) {
                    alert("收藏成功")
                } else if (res == 2) {
                    alert("取消收藏")
                } else {
                    alert("请先登录")
                }

            },
            dataType: "json",
        });
    })

    /**
     * 规范时间格式
     * @param data
     * @returns {string}
     */
    function time(data) {
        var date = new Date(data)
        var Y = date.getFullYear() + '-'
        var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-'
        var D = (date.getDate() < 10 ? '0' + date.getDate() : date.getDate()) + ' '
        var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':'
        var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':'
        var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds())
        return Y + M + D + h + m + s
    }

    /**
     * 举报功能
     */
    $("#report").click(function () {
        $.ajax({
            url: "comment/comment",
            type: "POST",
            data: {blogId: blogId, comment: $("#comment").val()},
            success: function (res) {
                if (res == 0) {
                    alert("请先登录")
                    return;
                }
                if (res == 2) {
                    alert("你已被封禁,无法进行评论操作")
                    return
                }else {
                    $("#show").show()
                    var formData = new FormData();
                    $("#submit").click(function () {
                        var file = $("#reportimg")[0].files[0];
                        formData.append("img", file)
                        formData.append("reportContent", encodeURI($("#reportcontent").val()))
                        formData.append("reportType", encodeURI($("#type").find("option:selected").val()))
                        formData.append("blogId", blogId)
                        if (user==null){
                            alert("请先登录")
                            return
                        }else if (file == null && $("#reportcontent").val() == "") {
                            alert("举报内容不能为空")
                            return;
                        }
                        $.ajax({
                            url: "report/report",
                            type: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            complete: function () {
                                location.reload()
                                alert("举报成功，请等待审核结果")
                            },
                        })
                    })
                }

            },
            dataType: "json",
        });

    })

    $("#cancelReport").click(function () {
        $("#show").hide()
    })

    function parent(comments) {
        for (var i = comments.length; i > 0; i--) {
            $("#commentList").append('<div>' + time(comments[i - 1].commentTime) + '</div>' + '<span>' + comments[i - 1].userNickName + '：' + comments[i - 1].content + '</span>' + '<button class="reply" id=' + comments[i - 1].commentId + '>' + '回复' + '</button>' + '<br>')
            childNode(comments[i - 1])
            $("#commentList").append('<br/>')
        }
    }

    function childNode(comment) {
        var child = comment.child;
        for (var i = child.length; i > 0; i--) {
            $("#commentList").append('<div>' + time(child[i - 1].commentTime) + '</div>' + '<span >' + child[i - 1].userNickName + '回复' + comment.userNickName + ':' + child[i - 1].content + '</span>' + '<button class="reply"id=' + child[i - 1].commentId + '>' + '回复' + '</button>' + '<br>')
            childNode(child[i - 1])
        }
    }

    var parentCommentId;
    $(document).on("click", '.reply', function () {
        $('#replyShow').show()
        parentCommentId = $(this).attr("id")
    })
    $('#push').click(function () {
        $.ajax({
            url: "comment/reply",
            type: "POST",
            data: {comment: $("#reply").val(), parentCommentId: parentCommentId, blogId: blogId},
            success: function (res) {
                if (res == 2) {
                    alert("你已经被封禁，无法发表评论")
                    return
                } else if (res == 0) {
                    alert("请先登录")
                    return
                } else {
                    alert("回复成功")
                }
                location.reload()
            },
        })
    })
    $("#cancel").click(function () {
        $("#replyShow").hide()
    })


</script>
</html>